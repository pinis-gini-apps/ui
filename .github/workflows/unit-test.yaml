name: Unit tests

on:
  push:
    branches:
      - remote-regression-test-runs
    paths:
      - 'src/components/**'

jobs:
  check-file-changes:
    runs-on: ubuntu-latest
    outputs:
      my_output: ${{ steps.run_custom_action.outputs.my_output }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install
        working-directory: .github/actions/pathRegression

      - name: Run Custom Action
        id: run_custom_action
        uses: ./.github/actions/pathRegression
        with:
          base-ref: ${{ toJson(github.event) }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Set output for next job
        id: set_output
        run: |
          echo "custom_output=${{ steps.run_custom_action.outputs.my_output }}" >> $GITHUB_ENV
          echo "${{ steps.run_custom_action.outputs.my_output }}"

  regression-test-forked:
    name: Regression Test in Forked Branch
    runs-on: ubuntu-latest
    needs: check-file-changes
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Run parallel tasks
        run: |
          echo "Custom output from previous job: ${{ needs.check-file-changes.outputs.my_output }}"
          TEST_TAG=${{ needs.check-file-changes.outputs.my_output }}  # Pass output from previous job
          
          # Run parallel tasks
          npm run add-comment-to-http-client &
          npm run mock-server &
          npm start &
          TEST_TAG=${{ needs.check-file-changes.outputs.my_output }} npm run path-test
